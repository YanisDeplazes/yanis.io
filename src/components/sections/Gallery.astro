---
// Imports
import Wrapper from '../../layouts/Wrapper.astro';
import ImageWrapper from '../wrappers/ImageWrapper.astro';

const { galleryData } = Astro.props;

// Dynamic imports
const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/images/galleries/**/*.{jpg,jpeg,png,webp}',
);

// Resolvers
const resolveImage = async (url: string) => images[`/src/assets${url}`]?.();

// Resolve all gallery media
const resolvedGallery = await Promise.all(
  galleryData.map(async (item: any) => ({
    ...item,
    resolvedImage: item.imageUrl ? await resolveImage(item.imageUrl) : null,
    resolvedThumbnail: item.thumbnail
      ? await resolveImage(item.thumbnail)
      : null,
  })),
);
---

<section class="gallery" data-background="var(--color-project)">
  <Wrapper>
    <div class="content masonry gallery">
      {
        resolvedGallery.map((item) => (
          <div class="item reveal-on-scroll">
            {item.resolvedImage ? (
              <ImageWrapper
                src={item.resolvedImage.default}
                alt={`Yanis Deplazes - ${item.imageAlt}`}
                caption={item.imageAlt}
              />
            ) : (
              <p>Image not found</p>
            )}
          </div>
        ))
      }
    </div>
  </Wrapper>
</section>

<style lang="scss">
  .gallery {
    .masonry {
      opacity: 0;
      position: relative;
      visibility: hidden;

      @media (max-width: 754px) {
        height: unset !important;
        display: flex;
        flex-direction: column;
        gap: var(--space-l);
      }

      .item {
        position: absolute;
        height: auto;
      }
    }
  }
</style>

<script>
  function getColumnCount(): number {
    const width = window.innerWidth;
    if (width < 900) return 1;
    return 2;
  }

  function resolveClamp(varName: string): number {
    const temp = document.createElement('div');
    temp.style.position = 'absolute';
    temp.style.visibility = 'hidden';
    temp.style.height = `var(${varName})`;
    document.body.appendChild(temp);

    const px = parseFloat(getComputedStyle(temp).height);
    document.body.removeChild(temp);

    return px;
  }

  function initMasonryGrid(
    containerSelector = '.masonry',
    itemSelector = '.item',
    gap = 24,
  ): void {
    const container = document.querySelector(
      containerSelector,
    ) as HTMLElement | null;
    if (!container) return;

    const items = Array.from(
      container.querySelectorAll(itemSelector),
    ) as HTMLElement[];
    if (items.length === 0) return;

    let columnCount = getColumnCount();

    const layout = () => {
      columnCount = getColumnCount();
      const columnHeights = Array(columnCount).fill(0);

      const containerWidth = container.clientWidth;
      const totalGap = (columnCount - 1) * gap;
      const columnWidthPx = (containerWidth - totalGap) / columnCount;

      let tallest = 0;

      items.forEach((item, index) => {
        const col = index % columnCount;
        const top = columnHeights[col];
        const left = col * (columnWidthPx + gap);

        item.style.position = 'absolute';
        item.style.width = `${columnWidthPx}px`;
        item.style.left = `${left}px`;
        item.style.transform = `translateY(${top}px)`;

        const height = item.offsetHeight;
        columnHeights[col] += height + gap;
        tallest = Math.max(tallest, columnHeights[col]);
      });

      container.style.position = 'relative';
      container.style.height = `${tallest}px`;
      container.style.opacity = '1';
      container.style.visibility = 'visible';
    };

    let resizeRaf: number | null = null;
    const onResize = () => {
      if (resizeRaf !== null) cancelAnimationFrame(resizeRaf);
      resizeRaf = requestAnimationFrame(layout);
    };

    layout();
    window.addEventListener('resize', onResize);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const gap = resolveClamp('--space-5xl');
    console.log(gap);
    initMasonryGrid('.masonry.gallery', '.item', gap);
  });
</script>
